<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CB可轉債發行資料查詢系統 - Rex大叔的168小股投資教室</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: #f5f5f5;
        }
        .header-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px 20px 20px;
            text-align: center;
        }
        .header-section h1 { font-size: 1.8em; margin-bottom: 15px; }
        .stats-banner {
            background: linear-gradient(90deg, #ffe5b4 0%, #ffd89b 100%);
            padding: 15px 20px;
            text-align: center;
            color: #8b4513;
            font-weight: bold;
        }
        .function-menu {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 12px;
            padding: 15px 20px;
            max-width: 1400px;
            margin: 0 auto;
            background: #f8f9fa;
        }
        .function-item {
            text-align: center;
            cursor: pointer;
            padding: 15px 10px;
            border-radius: 10px;
            background: white;
            border: 2px solid #e0e0e0;
        }
        .function-item.active {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-color: #667eea;
        }
        .section-block { display: none; padding: 40px 20px; }
        .section-block.active { display: block; }
        .table-wrapper {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin: 20px auto;
            max-width: 1200px;
            background: white;
        }
        table { width: 100%; border-collapse: collapse; }
        thead { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        th { padding: 10px 6px; text-align: center; font-weight: bold; font-size: 0.9em; }
        td { padding: 8px 6px; text-align: center; border-bottom: 1px solid #eee; font-size: 0.9em; }
        tbody tr:hover { background: #f8f9fa; }
        .highlight-red { background: #d32f2f; color: white; }
    </style>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="header-section">
        <h1>CB可轉債發行資料查詢系統</h1>
        <div>by Rex大叔的168小股投資教室</div>
    </div>

    <div class="stats-banner" id="statsBanner">📊 資料載入中...</div>

    <div class="function-menu">
        <div class="function-item" onclick="switchSection('section1', 0)">
            <div>🔍</div><div>單檔查詢</div>
        </div>
        <div class="function-item active" onclick="switchSection('section8', 7)">
            <div>📊</div><div>市場統計</div>
        </div>
    </div>

    <div class="content-section">
        <div id="section1" class="section-block">
            <div style="text-align:center; padding: 100px 20px; color:#999;">
                <div style="font-size: 3em;">🔍</div>
                <div style="font-size: 1.2em;">單檔查詢功能（已簡化）</div>
            </div>
        </div>

        <!-- 市場統計 -->
        <div id="section8" class="section-block active">
            <div style="text-align: center; margin-bottom: 30px;">
                <h2 style="color: #667eea; font-size: 2em;">📊 市場統計總覽</h2>
                <p style="color: #666; margin-top: 10px;">第一階段：基礎區間統計分析（按平均最高價排序）</p>
            </div>
            
            <!-- 整體概況 -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin: 20px auto; max-width: 1200px;">
                <h3 style="margin-bottom: 15px;">🌐 整體市場概況</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.9em; opacity: 0.9;">CB總數</div>
                        <div id="totalCount" style="font-size: 2em; font-weight: bold; margin-top: 5px;">-</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.9em; opacity: 0.9;">總發行規模</div>
                        <div id="totalSize" style="font-size: 2em; font-weight: bold; margin-top: 5px;">-</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.9em; opacity: 0.9;">平均最高價</div>
                        <div id="avgHighAll" style="font-size: 2em; font-weight: bold; margin-top: 5px;">-</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.9em; opacity: 0.9;">平均最低價</div>
                        <div id="avgLowAll" style="font-size: 2em; font-weight: bold; margin-top: 5px;">-</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.9em; opacity: 0.9;">平均振幅</div>
                        <div id="avgSwingAll" style="font-size: 2em; font-weight: bold; margin-top: 5px;">-</div>
                    </div>
                </div>
            </div>
            
            <!-- 1. 發行規模區間 -->
            <div style="background: white; border-radius: 12px; padding: 25px; margin: 20px auto; max-width: 1200px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h3 style="color: #667eea; margin-bottom: 20px; font-size: 1.3em;">💼 發行規模區間分析</h3>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>排名</th>
                                <th>規模區間</th>
                                <th>CB數量</th>
                                <th>平均規模(億)</th>
                                <th class="highlight-red">平均最高價</th>
                                <th>平均最低價</th>
                                <th>平均振幅(%)</th>
                            </tr>
                        </thead>
                        <tbody id="sizeRangeTable">
                            <tr><td colspan="7">載入中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 2. 股本大小區間 -->
            <div style="background: white; border-radius: 12px; padding: 25px; margin: 20px auto; max-width: 1200px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h3 style="color: #667eea; margin-bottom: 20px; font-size: 1.3em;">🏢 股本大小區間分析</h3>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>排名</th>
                                <th>股本區間</th>
                                <th>CB數量</th>
                                <th>平均股本(億)</th>
                                <th class="highlight-red">平均最高價</th>
                                <th>平均最低價</th>
                                <th>平均振幅(%)</th>
                            </tr>
                        </thead>
                        <tbody id="capitalRangeTable">
                            <tr><td colspan="7">載入中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 3. 轉換價格區間 -->
            <div style="background: white; border-radius: 12px; padding: 25px; margin: 20px auto; max-width: 1200px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h3 style="color: #667eea; margin-bottom: 20px; font-size: 1.3em;">💱 轉換價格區間分析</h3>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>排名</th>
                                <th>轉換價格區間</th>
                                <th>CB數量</th>
                                <th>平均轉換價(元)</th>
                                <th class="highlight-red">平均最高價</th>
                                <th>平均最低價</th>
                                <th>平均振幅(%)</th>
                            </tr>
                        </thead>
                        <tbody id="convPriceRangeTable">
                            <tr><td colspan="7">載入中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 4. 承銷方式 -->
            <div style="background: white; border-radius: 12px; padding: 25px; margin: 20px auto; max-width: 1200px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h3 style="color: #667eea; margin-bottom: 20px; font-size: 1.3em;">📢 承銷方式分析</h3>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>排名</th>
                                <th>承銷方式</th>
                                <th>CB數量</th>
                                <th>平均規模(億)</th>
                                <th class="highlight-red">平均最高價</th>
                                <th>平均最低價</th>
                                <th>平均振幅(%)</th>
                            </tr>
                        </thead>
                        <tbody id="methodTable">
                            <tr><td colspan="7">載入中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 5. 擔保類型 -->
            <div style="background: white; border-radius: 12px; padding: 25px; margin: 20px auto; max-width: 1200px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h3 style="color: #667eea; margin-bottom: 20px; font-size: 1.3em;">🛡️ 擔保類型分析</h3>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>排名</th>
                                <th>擔保類型</th>
                                <th>CB數量</th>
                                <th>平均規模(億)</th>
                                <th class="highlight-red">平均最高價</th>
                                <th>平均最低價</th>
                                <th>平均振幅(%)</th>
                            </tr>
                        </thead>
                        <tbody id="guaranteeTable">
                            <tr><td colspan="7">載入中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 6. 簡化基本統計 -->
            <div style="background: white; border-radius: 12px; padding: 25px; margin: 20px auto; max-width: 1200px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h3 style="color: #667eea; margin-bottom: 20px; font-size: 1.3em;">📊 基本條件統計</h3>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>排名</th>
                                <th>分類條件</th>
                                <th>CB數量</th>
                                <th>總規模(億)</th>
                                <th class="highlight-red">平均最高價</th>
                                <th>平均最低價</th>
                                <th>平均振幅(%)</th>
                            </tr>
                        </thead>
                        <tbody id="basicStatsTable">
                            <tr><td colspan="7">載入中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let mockData = [];
        
        // 測試資料
        function loadMockData() {
            mockData = [
                {cbCode: '29131', cbName: '農林一', stockCode: '2913', size: 7.5, guarantee: '有擔保', year: 3.0, convPrice: 17.8, high: 160.0, low: 99.5, capital: '79.0', method: '詢圈'},
                {cbCode: '62074', cbName: '雷科四', stockCode: '6207', size: 6.0, guarantee: '無擔保', year: 5.0, convPrice: 53.6, high: 109.95, low: 99.0, capital: '7.97', method: '詢圈'},
                {cbCode: '23952', cbName: '研華二', stockCode: '2395', size: 8.0, guarantee: '無擔保', year: 3.0, convPrice: 94.04, high: 274.0, low: 104.0, capital: '85.8', method: '詢圈'},
                {cbCode: '30193', cbName: '亞光三', stockCode: '3019', size: 10.0, guarantee: '有擔保', year: 3.0, convPrice: 58.5, high: 110.5, low: 96.2, capital: '27.9', method: '詢圈'}
            ];
            updateStatsBanner();
            initMarketStats();
        }
        
        // 從GitHub載入
        async function loadExcelData() {
            try {
                const url = "https://rexdashu168.github.io/cbhistory168/cb_issue.xlsx";
                const response = await fetch(url + '?t=' + Date.now(), { cache: 'no-cache', mode: 'cors' });
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: "array" });
                const sheet = workbook.Sheets["allcbissue"];
                const jsonData = XLSX.utils.sheet_to_json(sheet);
                
                mockData = jsonData.map(row => ({
                    cbCode: String(row["CB代號"] || ""),
                    cbName: row["CB名稱"] || "",
                    stockCode: String(row["股票代號"] || ""),
                    size: parseFloat(row["發行規模"] || 0),
                    guarantee: row["有無擔保"] || "",
                    year: parseFloat(row["發行年期"] || 0),
                    convPrice: parseFloat(row["轉換價格"] || 0),
                    high: parseFloat(row["掛牌最高"] || 0),
                    low: parseFloat(row["掛牌最低"] || 0),
                    capital: String(row["股本規模"] || ""),
                    method: row["承銷方式"] || ""
                }));
                
                updateStatsBanner();
                initMarketStats();
            } catch (error) {
                console.error('載入失敗，使用測試資料:', error);
                loadMockData();
            }
        }
        
        function updateStatsBanner() {
            document.getElementById('statsBanner').innerHTML = 
                `📊 資料期間: 2006~2025,共計 <strong>${mockData.length}</strong> 檔 | 💰 最後更新: ${new Date().toLocaleDateString('zh-TW')}`;
        }
        
        function switchSection(sectionId, index) {
            document.querySelectorAll('.section-block').forEach(block => block.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            
            document.querySelectorAll('.function-item').forEach((item, i) => {
                if (i === index) item.classList.add('active');
                else item.classList.remove('active');
            });
            
            if (sectionId === 'section8') initMarketStats();
        }
        
        function calculateStats(data) {
            const count = data.length;
            if (count === 0) return { count: 0, totalSize: 0, avgSize: 0, avgHigh: 0, avgLow: 0, avgSwing: 0, avgValue: 0 };
            
            const totalSize = data.reduce((s, d) => s + d.size, 0);
            const avgSize = totalSize / count;
            const avgHigh = data.reduce((s, d) => s + d.high, 0) / count;
            const avgLow = data.reduce((s, d) => s + d.low, 0) / count;
            const avgSwing = data.reduce((s, d) => s + ((d.high - d.low) / d.low * 100), 0) / count;
            
            // 計算平均股本（僅當區間統計時使用）
            const avgCapital = data.reduce((s, d) => s + parseFloat(d.capital || 0), 0) / count;
            const avgConvPrice = data.reduce((s, d) => s + d.convPrice, 0) / count;
            
            return { 
                count, 
                totalSize, 
                avgSize, 
                avgHigh, 
                avgLow, 
                avgSwing,
                avgCapital,
                avgConvPrice
            };
        }
        
        function initMarketStats() {
            const total = mockData.length;
            const stats = calculateStats(mockData);
            
            document.getElementById('totalCount').textContent = total + '檔';
            document.getElementById('totalSize').textContent = stats.totalSize.toFixed(1) + '億';
            document.getElementById('avgHighAll').textContent = stats.avgHigh.toFixed(1);
            document.getElementById('avgLowAll').textContent = stats.avgLow.toFixed(1);
            document.getElementById('avgSwingAll').textContent = stats.avgSwing.toFixed(1) + '%';
            
            // 生成各區間統計
            generateSizeRangeStats();
            generateCapitalRangeStats();
            generateConvPriceRangeStats();
            generateMethodStats();
            generateGuaranteeStats();
            generateBasicStats();
        }
        
        // 1. 發行規模區間統計
        function generateSizeRangeStats() {
            const ranges = [
                { label: '2億以下', filter: d => d.size > 0 && d.size <= 2 },
                { label: '2-5億', filter: d => d.size > 2 && d.size <= 5 },
                { label: '5-10億', filter: d => d.size > 5 && d.size <= 10 },
                { label: '10-15億', filter: d => d.size > 10 && d.size <= 15 },
                { label: '15-20億', filter: d => d.size > 15 && d.size <= 20 },
                { label: '20億以上', filter: d => d.size > 20 }
            ];
            
            const results = ranges.map(range => {
                const data = mockData.filter(range.filter);
                const stats = calculateStats(data);
                return { label: range.label, ...stats };
            }).filter(r => r.count > 0)
              .sort((a, b) => b.avgHigh - a.avgHigh);
            
            const tbody = document.getElementById('sizeRangeTable');
            tbody.innerHTML = results.map((r, i) => `
                <tr>
                    <td><strong>${i + 1}</strong></td>
                    <td style="text-align: left; padding-left: 10px;">${r.label}</td>
                    <td>${r.count}</td>
                    <td>${r.avgSize.toFixed(1)}</td>
                    <td style="color: #d32f2f; font-weight: bold;">${r.avgHigh.toFixed(1)}</td>
                    <td>${r.avgLow.toFixed(1)}</td>
                    <td>${r.avgSwing.toFixed(1)}</td>
                </tr>
            `).join('');
        }
        
        // 2. 股本大小區間統計
        function generateCapitalRangeStats() {
            const ranges = [
                { label: '3億以下', filter: d => parseFloat(d.capital) > 0 && parseFloat(d.capital) <= 3 },
                { label: '3-6億', filter: d => parseFloat(d.capital) > 3 && parseFloat(d.capital) <= 6 },
                { label: '6-10億', filter: d => parseFloat(d.capital) > 6 && parseFloat(d.capital) <= 10 },
                { label: '10-15億', filter: d => parseFloat(d.capital) > 10 && parseFloat(d.capital) <= 15 },
                { label: '15-20億', filter: d => parseFloat(d.capital) > 15 && parseFloat(d.capital) <= 20 },
                { label: '20億以上', filter: d => parseFloat(d.capital) > 20 }
            ];
            
            const results = ranges.map(range => {
                const data = mockData.filter(range.filter);
                const stats = calculateStats(data);
                return { label: range.label, ...stats };
            }).filter(r => r.count > 0)
              .sort((a, b) => b.avgHigh - a.avgHigh);
            
            const tbody = document.getElementById('capitalRangeTable');
            tbody.innerHTML = results.map((r, i) => `
                <tr>
                    <td><strong>${i + 1}</strong></td>
                    <td style="text-align: left; padding-left: 10px;">${r.label}</td>
                    <td>${r.count}</td>
                    <td>${r.avgCapital.toFixed(1)}</td>
                    <td style="color: #d32f2f; font-weight: bold;">${r.avgHigh.toFixed(1)}</td>
                    <td>${r.avgLow.toFixed(1)}</td>
                    <td>${r.avgSwing.toFixed(1)}</td>
                </tr>
            `).join('');
        }
        
        // 3. 轉換價格區間統計
        function generateConvPriceRangeStats() {
            const ranges = [
                { label: '20元以下', filter: d => d.convPrice > 0 && d.convPrice <= 20 },
                { label: '20-50元', filter: d => d.convPrice > 20 && d.convPrice <= 50 },
                { label: '50-100元', filter: d => d.convPrice > 50 && d.convPrice <= 100 },
                { label: '100-150元', filter: d => d.convPrice > 100 && d.convPrice <= 150 },
                { label: '150-200元', filter: d => d.convPrice > 150 && d.convPrice <= 200 },
                { label: '200元以上', filter: d => d.convPrice > 200 }
            ];
            
            const results = ranges.map(range => {
                const data = mockData.filter(range.filter);
                const stats = calculateStats(data);
                return { label: range.label, ...stats };
            }).filter(r => r.count > 0)
              .sort((a, b) => b.avgHigh - a.avgHigh);
            
            const tbody = document.getElementById('convPriceRangeTable');
            tbody.innerHTML = results.map((r, i) => `
                <tr>
                    <td><strong>${i + 1}</strong></td>
                    <td style="text-align: left; padding-left: 10px;">${r.label}</td>
                    <td>${r.count}</td>
                    <td>${r.avgConvPrice.toFixed(1)}</td>
                    <td style="color: #d32f2f; font-weight: bold;">${r.avgHigh.toFixed(1)}</td>
                    <td>${r.avgLow.toFixed(1)}</td>
                    <td>${r.avgSwing.toFixed(1)}</td>
                </tr>
            `).join('');
        }
        
        // 4. 承銷方式統計
        function generateMethodStats() {
            const methods = [...new Set(mockData.map(d => d.method))].filter(m => m);
            
            const results = methods.map(method => {
                const data = mockData.filter(d => d.method === method);
                const stats = calculateStats(data);
                return { label: method, ...stats };
            }).sort((a, b) => b.avgHigh - a.avgHigh);
            
            const tbody = document.getElementById('methodTable');
            tbody.innerHTML = results.map((r, i) => `
                <tr>
                    <td><strong>${i + 1}</strong></td>
                    <td style="text-align: left; padding-left: 10px;">${r.label}</td>
                    <td>${r.count}</td>
                    <td>${r.avgSize.toFixed(1)}</td>
                    <td style="color: #d32f2f; font-weight: bold;">${r.avgHigh.toFixed(1)}</td>
                    <td>${r.avgLow.toFixed(1)}</td>
                    <td>${r.avgSwing.toFixed(1)}</td>
                </tr>
            `).join('');
        }
        
        // 5. 擔保類型統計
        function generateGuaranteeStats() {
            const types = [...new Set(mockData.map(d => d.guarantee))].filter(g => g);
            
            const results = types.map(type => {
                const data = mockData.filter(d => d.guarantee === type);
                const stats = calculateStats(data);
                return { label: type, ...stats };
            }).sort((a, b) => b.avgHigh - a.avgHigh);
            
            const tbody = document.getElementById('guaranteeTable');
            tbody.innerHTML = results.map((r, i) => `
                <tr>
                    <td><strong>${i + 1}</strong></td>
                    <td style="text-align: left; padding-left: 10px;">${r.label}</td>
                    <td>${r.count}</td>
                    <td>${r.avgSize.toFixed(1)}</td>
                    <td style="color: #d32f2f; font-weight: bold;">${r.avgHigh.toFixed(1)}</td>
                    <td>${r.avgLow.toFixed(1)}</td>
                    <td>${r.avgSwing.toFixed(1)}</td>
                </tr>
            `).join('');
        }
        
        // 6. 基本條件統計（規模≥10億 vs <10億等）
        function generateBasicStats() {
            const conditions = [
                { label: '規模≥10億', filter: d => d.size >= 10 },
                { label: '規模<10億', filter: d => d.size < 10 },
                { label: '轉換價≥100元', filter: d => d.convPrice >= 100 },
                { label: '轉換價<100元', filter: d => d.convPrice < 100 },
                { label: '股本≥10億', filter: d => parseFloat(d.capital) >= 10 },
                { label: '股本<10億', filter: d => parseFloat(d.capital) < 10 }
            ];
            
            const results = conditions.map(cond => {
                const data = mockData.filter(cond.filter);
                const stats = calculateStats(data);
                return { label: cond.label, ...stats };
            }).filter(r => r.count > 0)
              .sort((a, b) => b.avgHigh - a.avgHigh)
              .slice(0, 6);
            
            const tbody = document.getElementById('basicStatsTable');
            tbody.innerHTML = results.map((r, i) => `
                <tr>
                    <td><strong>${i + 1}</strong></td>
                    <td style="text-align: left; padding-left: 10px;">${r.label}</td>
                    <td>${r.count}</td>
                    <td>${r.totalSize.toFixed(1)}</td>
                    <td style="color: #d32f2f; font-weight: bold;">${r.avgHigh.toFixed(1)}</td>
                    <td>${r.avgLow.toFixed(1)}</td>
                    <td>${r.avgSwing.toFixed(1)}</td>
                </tr>
            `).join('');
        }
        
        window.addEventListener('DOMContentLoaded', () => {
            loadExcelData();
        });
    </script>
</body>
</html>
